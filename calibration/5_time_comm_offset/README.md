# 5_time_comm_offset

This repository contains scripts for calibrating out time offsets for the detector geometry.

## Compiling
### .cpp files

```terminal
g++ a.cpp $(root-config --cflags --glibs) -o a
```

## Procedure
### 1. Batch Generation

batch_generator_final.cpp is used to generate batches of tracks from simulated data, for the iterator. It takes in .root files in the data_dir directory, and produces .root batch files in the recorded_dir directory. The number of tracks per batch can be altered on line 181, and the number of batches on line 182.

First, the data files are read and the tracks that fit the selection criteria (line 107) are recorded. For each detector, a randomized time offset is generated, stored in a "truth_offsets.txt" file in the recorded_dir directory. That time offset is applied to each hit for that detector (see line 113).

Example:

g++ batch_generator_final.cpp $(root-config --cflags --glibs) -o batch_gen_fin

```bash
#!/bin/bash
WORKING_DIR=/project/6049244/data/MATHUSLA/simulation/run-2024-07-cosmic-muon
DATA_DIR=${WORKING_DIR}/DigiOutput
REC_DIR=${WORKING_DIR}/OffsetCalib

./batch_gen_fin ${DATA_DIR} ${REC_DIR}

```

### 2a. Iterator

iterator_final.cpp iterates through the batches stored in the data_dir directory. Muon track speed can be set on line 29. Learning rate is set on line 50. It assumes the basenames of the batches are less than 10 characters (see line 40). After going through each file, the current predicted offsets are output to a pred_offsets{i}.txt file, in the data_dir directory. The lin_regress function performs linear regression on a vector of xs and a vector of ys, and outputs the slope and intercept in slopeint. 

Example:

g++ iterator_final.cpp $(root-config --cflags --glibs) -o iter_fin

```bash
#!/bin/bash
WORKING_DIR=/project/6049244/data/MATHUSLA/simulation/run-2024-07-cosmic-muon
DATA_DIR=${WORKING_DIR}/DigiOutput
REC_DIR=${WORKING_DIR}/OffsetCalib

./iter_fin ${REC_DIR}
```

### 2b. Iterator scans

iterator_final_scan.cpp performs the same steps as iterator_final.cpp, however it performs the process for multiple values of muon track speed and outputs the results to different directories in the data_dir directory. These directories are created on line 54. The different muon track speeds can be set on line 48.

## Analysis
### 1. Velocity Iterator

velocity_iterator_final.cpp is used to process the data put into the batch generator, and generate a histogram in the output_dir folder. The selection criteria for the track is set on line 96, and the velocity is calculated from line 108.

Example:

g++ velocity_iterator_final.cpp $(root-config --cflags --glibs) -o vel_iter_fin

```bash
#!/bin/bash
WORKING_DIR=/project/6049244/data/MATHUSLA/simulation/run-2024-07-cosmic-muon
DATA_DIR=${WORKING_DIR}/DigiOutput
REC_DIR=${WORKING_DIR}/OffsetCalib

./vel_iter_fin ${DATA_DIR} ${REC_DIR}
```

### 2. Velocity Check

velocity_check.ipynb takes in the output of track reconstruction .pkl files, produced by the simulation. It generates a histogram of the velocities, then fits it to a Gaussian curve.

### 3. Offset Comparison

offset_comparison.ipynb takes in the predicted offset files generated by iter_final_scan.cpp, and calculates the differences between those predicted offsets and the truth offset values. The final standard deviations are plotted against the muon speed of each scan. This is then fitted to a quadratic and a spline. At the end, an individual scan can be analyzed and histograms of the differences between truth and predicted offsets are plotted, as well as the change in standard deviation of the differences from iteration to iteration.

### 4. Track Reconstruction Fits

rec_fit.ipynb applies a track reconstruction fit to the recorded tracks (post-selection criteria, pre-batching) and generates a histogram of the track speeds.That histgram is fitted to a gaussian to find the peak value. The velocity histogram .root file generated from velocity_iterator_final.cpp is converted into numpy arrays and plotted.